% Source (with comments) can be found at https://github.com/Strauman/includeRnw/
%% The LaTeX package includeRnw - version v0.0.2 (2018/04/21) - build 7
%% includeRnw.sty
%% -------------------------------------------------------------------------------------------
%% Copyright (c) 2018 by Andreas Storvik Strauman <andreas dot s dot strauman at uit dot no>
%% -------------------------------------------------------------------------------------------
%% This work may be distributed and/or modified under the
%% conditions of the LaTeX Project Public License, either version 1.3c
%% of this license or (at your option) any later version.
%% The latest version of this license is in
%%   http://www.latex-project.org/lppl.txt
%% and version 1.3c or later is part of all distributions of LaTeX
%% version 2008/05/04 or later.
%% This work has the LPPL maintenance status `author-maintained'.
%% This work consists of all files listed in README
\ProvidesPackage{includeRnw}[2018/04/21 v0.0.2 Makes commands for including external .Rnw files.]
\providecommand\rnw@loglevel{0}
\RequirePackage{pdftexcmds}
\let\incl\input
\def\rnw@True{1}
\def\rnw@False{0}
\let\rnw@opt@halt\rnw@False
\let\rnw@opt@new\rnw@False
\DeclareOption{halt}{\global\let\rnw@opt@halt\rnw@True}
\DeclareOption{new}{\global\let\rnw@opt@new\rnw@True}
\ProcessOptions\relax
\if\rnw@opt@halt\rnw@True
  \if\rnw@opt@new\rnw@True
    \@latex@warning{includeRnw: can't use halt and new together. Falling back to new.}
    \let\rnw@opt@halt\rnw@False
  \fi
\fi
\def\rnw@dir@input{.}
\def\rnw@dir@output{./knitrout}
\def\rnw@suffix{knitted}
\def\rnw@file@knitlog{\rnw@dir@output/knitlog.log}
\def\rnw@filebase@knithead{\rnw@dir@output/knithead}
\def\insp#1{\texttt{\string#1:\meaning#1}}
\def\inspw#1{\@latex@warning{\string#1:\meaning#1}}
\providecommand\rnw@loglevel{3}
\newcommand\@dlog[2][1]{\ifnum\rnw@loglevel>#1\relax\@latex@warning{#2}\fi}
\def\rnw@filename@parse#1{%
 \filename@parse{#1}
 \edef\rnw@filepath{\filename@area\filename@base}
 \edef\rnw@filebase{\filename@base}
 \edef\rnw@fileext{\ifx\filename@ext\relax Rnw\else\filename@ext\fi}
 \edef\rnw@infile@fullpath{\filename@area\filename@base.\filename@ext}
}
\def\rnw@clear@knitlog{%
\immediate\write18{echo "" > \rnw@file@knitlog}
}
\def\rnw@check@ouput@file{\rnw@dir@output/.includeRnwShellEscapeCheck}
\def\check@shell@escape{%
  \ifcase\pdf@shellescape%
  \PackageError{includeRnw}{\string\includeRnw\space requires --shell-escape}{}\stop\or%
  \message{Shell escape test passed}\or%
  \PackageError{includeRnw}{\string\includeRnw\space requires --shell-escape. Current is restricted shell escape}{}\stop\fi%
}
\def\check@output@dir{%
  \immediate\write18{touch \rnw@check@ouput@file}
  \IfFileExists{\rnw@check@ouput@file}{}{%
    \immediate\write18{mkdir \rnw@dir@output}
}
  \immediate\write18{rm \rnw@check@ouput@file}
}
\def\rnw@include@knithead{%
  \IfFileExists{\rnw@filebase@knithead.tex}{}{%
    \@dlog[0]{Creating knithead}
    \immediate\write18{echo "<<create-preamble,echo=FALSE,results='asis'>>=\string\ncat(knitr:::make_header_latex())\string\n@" > \rnw@filebase@knithead.Rnw}
    \immediate\write18{R -e 'library("knitr");knit("\rnw@filebase@knithead.Rnw","\rnw@filebase@knithead.tex")' >> \rnw@file@knitlog}
}
  \IfFileExists{\rnw@filebase@knithead.tex}{\@dlog[0]{Including knithead}\incl{\rnw@dir@output/knithead.tex}}{\PackageError{includeRnw}{Could not find knitr preamble: \rnw@dir@output/knithead.tex}{}}
}
\xdef\rnw@gopt@force{f}
\xdef\rnw@gopt@halt{h}
\def\ifrnw@should@knitr{%
  \newif\ifrnw@build
  \@dlog[0]{Deciding wether or not to knit \rnw@infile@fullpath:}
  \rnw@buildtrue
  \ifnum\pdfstrcmp{\rnw@gopt@halt}{\givenopt}=\z@%
    \let\rnw@local@halt\rnw@True
  \else%
    \let\rnw@local@halt\rnw@opt@halt
  \fi
  \let\rnw@local@new\rnw@opt@new
  \if\rnw@opt@new\rnw@True\relax%
    \if\rnw@local@halt\rnw@True\relax%
      \let\rnw@local@new\rnw@False
    \fi
  \fi
  \@dlog[2]{- Options resulted in:}
  \@dlog[2]{- new: \rnw@local@new}
  \@dlog[2]{- halt: \rnw@local@halt}
  \ifnum\pdfstrcmp{\rnw@gopt@force}{\givenopt}=\z@\rnw@buildtrue\else%
    \if\rnw@local@halt\rnw@True%
      \rnw@buildfalse
    \else
      \if\rnw@opt@new\rnw@True%
        \IfFileExists{\knitOutfile}{\rnw@buildfalse}{\rnw@buildtrue}
        \else
        \rnw@buildtrue
      \fi
    \fi
  \fi
\ifrnw@build
}
\providecommand\rnw@execute@knitr[2][]{%
  \def\givenopt{#1}
  \rnw@filename@parse{#2}
  \xdef\knitOutfile{\rnw@dir@output/\filename@base\rnw@suffix.tex}
  \ifrnw@should@knitr
    \IfFileExists{\rnw@infile@fullpath}{      \@dlog[2]{Building \rnw@infile@fullpath\space to \rnw@dir@output/\filename@base\rnw@suffix.tex}
      \immediate\write18{R -e 'library("knitr");knit("\rnw@dir@input/\rnw@infile@fullpath",  "\rnw@dir@output/\filename@base\rnw@suffix.tex")' &> \rnw@file@knitlog}
}{\@latex@error{includeRnw: Could not find file that I was asked to knit: \rnw@infile@fullpath!}{}\stop}
  \else\@dlog[2]{- Skipping knit of \rnw@infile@fullpath}
  \fi
  \IfFileExists{\knitOutfile}{%
    \@dlog[2]{Found \knitOutfile. Including it.}
    \incl{\knitOutfile}
}{%
    \PackageError{includeRnw}{Couldn't find knitted file: \knitOutfile}{}
}
}
\check@shell@escape
\check@output@dir
\rnw@clear@knitlog
\let\includeRnw\rnw@execute@knitr
\rnw@include@knithead
